<div class="" ng-controller="InfoSummaryCtrl">

    <!-- Display an error message if the user haven't select a project yet -->
    <div class="container alert alert-danger col-sm-offset-3 col-sm-6 text-center"
         ng-hide="getActiveProject().id" role="alert">
        <span class="glyphicon glyphicon-exclamation-sign"
              aria-hidden="true"></span>
        <span class="sr-only">Error:</span>
        No project selected. In order to view a graph, you need to select or
        create
        a project!
    </div>

    <div ng-show="getActiveProject().id">
        <div class="container lead panel">
            <dl class="dl-horizontal">
                <dt>ID:</dt>
                <dd>{{activeProject.id}}</dd>

                <dt>Project Name:</dt>
                <dd>{{activeProject.name}}</dd>

                <dt>Options:</dt>
                <dd>
                    <!-- =============== PROJECT GRAPH OPTIONS =============== -->
                    <div class="btn-group" role="group" aria-label="...">
                        <!-- back btn-->
                        <a class="btn btn-default hvr-icon-back"
                           ng-href=" #project"
                           data-trigger="hover" data-placement="bottom"
                           title="Return to the project listings">
                            Back &nbsp;
                        </a>

                        <!-- reset btn -->
                        <button type="button"
                                class="btn btn-default hvr-icon-sink-away"
                                data-trigger="hover" data-placement="bottom"
                                data-toggle="modal" data-target=".reset"
                                title="Clear the graph. Be careful!">
                            Reset &nbsp;
                        </button>

                        <!-- save btn -->
                        <button type="button"
                                class="btn btn-default hvr-icon-push"
                                data-trigger="hover" data-placement="bottom"
                                data-toggle="modal" data-target=".save"
                                title="Save the current state of the graph for future used">
                            Save &nbsp;
                        </button>

                        <!-- load btn -->
                        <button type="button"
                                class="btn btn-default hvr-icon-spin"
                                data-trigger="hover" data-placement="bottom"
                                data-toggle="modal" data-target=".load"
                                title="Load the the graph previous saved state">
                            Load &nbsp;
                        </button>

                        <!-- run project btn-->
                        <button data-trigger="hover" data-placement="bottom"
                                class="btn" ng-class="getBtnClass()"
                                title="Start the project"
                                ng-click="toggleRunBtn(run,stop)">
                            {{displayBtnText('Run Project')}}
                            <i class="fa fa-cog fa-fw "
                               ng-class="getIconClass()">
                            </i>
                        </button>
                    </div>
                </dd>
            </dl>


            <!-- =============== CONFIRMATION MODAL =============== -->

            <!-- ensure that button and confirm-box are matching! example below
            The data-target should be preceded by a period: . (It is a class)

            on the button element: : data-toggle="modal" data-target=".reset"
            on the confirm-box element: target="reset"-->

            <!-- reset -->
            <confirm-box target="reset" title="Confirm Reset"
                         update-fn="resetGraph()"
                         content="All unsaved changes will be lost. Please confirm.">
            </confirm-box>

            <!-- save -->
            <confirm-box target="save" title="Confirm Save"
                         update-fn="saveGraph()"
                         content="All changes to the graph will be saved. Please confirm.">
            </confirm-box>

            <!-- load -->
            <confirm-box target="load" title="Confirm Load"
                         update-fn="loadGraph()"
                         content="All unsaved changes will be lost when you load a graph. Please confirm.">
            </confirm-box>
        </div>

        <div id="paper" ng-show="getActiveProject().id"></div>
    </div>
</div>

<script>
    /* =============== BOOTSTRAP =============== */
    // need to manually opt it for bootstrap tooltip
    $(function() {
        $('[data-trigger="hover"]').tooltip()
    });


    /* =============== JOINT JS =============== */
    /**
     * MAIN_GRAPH is an empty Graph object instantiated from the
     * joint_setup.js file
     *
     * When the user loads up a graph, they are reassigning MAIN_GRAPH to whatever
     * graph the user has. It would look like this: MAIN_GRAPH = joeProject.graph
     *
     * DEFAULT_GRAPH is the graph every users starts out with. BUT it is not the graph
     * that will be display by default to the view.
     *
     * The view will update base on whatever the graph is
     *
     * Paper is the container for the view, the window to the view.
     */
    var linklist = [];
    var paper = new joint.dia.Paper({
        el: $('#paper'),
        width: 1800,
        height: 1000,
        gridSize: 10,
        model: MAIN_GRAPH,
        defaultLink: function() {
            link = new joint.dia.Link({
                router: { name: 'metro' },
                connector: { name: 'rounded' },
                attrs: {
                    '.connection': {
                        stroke: '#333333',
                        'stroke-width': 3
                    },
                    '.marker-target': {
                        fill: '#333333',
                        d: 'M 10 0 L 0 5 L 10 10 z'
                    }
                }
            });
            linklist.push(link)
            console.log(linklist)
            return link
        }
    });

    var source = new joint.shapes.devs.Coupled({
        position: { x: 50, y: 50 },
        size: { width: 140, height: 70 },
        inPorts : ['In'],
        outPorts: ['Out'],
        attrs: {
            '.label'            : { text: 'Source', 'data-toggle': 'popover', title: 'Modify Me!',
                'data-content':
                        '<form action="action_page.php"> \
                          Type:<br> \
                          <select name="type"> \
                            <option value="Service">Service</option> \
                            <option value="Graph">Graph</option> \
                          </select><br> \
                          Service:<br> \
                          <select name="service"> \
                            <option value="WeatherByZip">WeatherByZip</option> \
                            <option value="WeatherByCity">WeatherByCity</option> \
                            <option value="calc_add">CalculatorAdd</option> \
                            <option value="calc_sub">CalculatorSubtract</option> \
                            <option value="calc_mul">CalculatorMultiply</option> \
                            <option value="calc_div">CalculatorDivide</option> \
                          </select><br> \
                          Endpoint:<br> \
                          <select name="serviceEndpoint"> \
                            <option value="foo">Foo</option> \
                            <option value="bar">Bar</option> \
                          </select><br> \
                          <input type="submit" value="Save"><button>Edit...</button><button>Delete</button></form>',
                'data-html' : 'true', 'data-container' : 'body' },
            rect                : { fill: '#d9534f'},

            '.inPorts circle'   : { fill: '#16A085', magnet: 'passive', type: 'input',r:'10' },
            '.outPorts circle'  : { fill: '#E74C3C', type: 'output',r:'10' }
        }
    });

    var target = source.clone().translate(750, 400).attr('text/text', 'Target');

    var link = new joint.dia.Link({
        source: {
            id: source.id,
            port:"Out"
        },
        target: {
            id: target.id,
            port:"In"
        },
        router: { name: 'metro' },
        connector: { name: 'rounded' },
        attrs: {
            '.connection': {
                stroke: '#333333',
                'stroke-width': 3
            },
            '.marker-target': {
                fill: '#333333',
                d: 'M 10 0 L 0 5 L 10 10 z'
            }
        }
    });
    linklist.push(link);

    var obstacle = source.clone().translate(300, 100).attr({
        text: {
            text: 'Obstacle',
            fill: '#eee'
        }
    });

    var obstacles = [
        obstacle,
        obstacle.clone().translate(200, 100),
        obstacle.clone().translate(-200, 150)
    ];

    DEFAULT_GRAPH.addCells(obstacles).addCells([source, target, link]);

    link.toBack();

    DEFAULT_GRAPH.on('change:position', function(cell) {
        // has an obstacle been moved? Then reroute the link.
        for (var i=0,  tot=linklist.length; i < tot; i++) paper.findViewByModel(linklist[i]).update();
    });
    $('.router-switch').on('click', function(evt) {

        var router = $(evt.target).data('router');
        var connector = $(evt.target).data('connector');

        if (router) {
            link.set('router', { name: router });
        } else {
            link.unset('router');
        }

        link.set('connector', { name: connector });
    });
    $('#add_butt').click(function() {

        var newNode = new joint.shapes.devs.Coupled({
            position: { x: 500, y: 300 },
            size: { width: 140, height: 70 },
            inPorts : ['In'],
            outPorts: ['Out'],
            attrs: {
                '.label'            : { text: $("#add_select").val()},
                rect                : { fill: '#d9534f' },

                '.inPorts circle'   : { fill: '#16A085', magnet: 'passive', type: 'input',r:'10' },
                '.outPorts circle'  : { fill: '#E74C3C', type: 'output',r:'10' }
            }
        });
        DEFAULT_GRAPH.addCell(newNode);
    });



</script>